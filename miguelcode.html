<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ejercicios: Tuberías en Serie</title>
    <style>
        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            padding: 24px;
            background: #f7f9fc;
            color: #0f172a
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(12,20,45,0.08)
        }

        h1 {
            margin-top: 0
        }

        .exercise {
            display: none;
        }

            .exercise.active {
                display: block;
            }

        .controls {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .feedback {
            margin-top: 8px;
            font-weight: 600
        }

            .feedback.error {
                color: #b91c1c
            }

            .feedback.success {
                color: #0f9d58
            }

        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e1
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 0;
            cursor: pointer
        }

            button.primary {
                background: #2563eb;
                color: white
            }

            button.secondary {
                background: #94a3b8;
                color: white
            }

        .solution {
            margin-top: 10px;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            }

        .nav {
            display: flex;
            gap: 8px;
            margin-top: 16px
        }

        .retroalimentacion {
            background: #f1f5f9;
            border-left: 4px solid #2563eb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

            .retroalimentacion h3 {
                margin-top: 0;
                color: #1e3a8a
            }
    </style>
    <!--libreria para LATEX-->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBCyushdUDl0mIBxCl50mkbRpz-FfZyqU4",
    authDomain: "fluidmechanicsproject.firebaseapp.com",
    projectId: "fluidmechanicsproject",
    storageBucket: "fluidmechanicsproject.firebasestorage.app",
    messagingSenderId: "969525156162",
    appId: "1:969525156162:web:bae9cceaf79e88ac8d50db"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- PARTE IMPORTANTE: HACERLAS GLOBALES ---
  // Asignamos las funciones al objeto window para que el otro script las vea
  window.db = db;
  window.collection = collection;
  window.addDoc = addDoc;
  
  console.log("Firebase cargado y funciones expuestas globalmente.");
</script>

<body>
<label><b>Nombre del estudiante:</b></label>
<input type="text" id="nombre_estudiante" placeholder="Escribe tu nombre" 
       style="width: 250px; margin-bottom: 20px; padding: 6px;">

    <div class="container">

        <h1>Ejercicios: Tuberías en Serie</h1>
        <p>Responde las preguntas en los cuadros de texto. Si tu respuesta es correcta, verás la retroalimentación con el proceso completo.</p>

        <div id="exercises">

            <!-- Ejercicio 1 -->
            <section class="exercise active" data-index="0" id="ex-0">
                <h2>Ejercicio 1</h2>
                <p>
                    Para el sistema mostrado en la figura fluye agua a
                    <input type="number" id="temperature" placeholder="Insertar T" min="32" max="212" style="width: 90px; height: 20px ;font-size: 16px;"> °F
                    por una tuberia de hierro ductil revestida cuyos diametros son
                    <input type="number" id="diametro_1" placeholder="diametro 1" min="3" max="25" style="width: 90px; height: 20px ;font-size: 16px;"> ,
                    <input type="number" id="diametro_2" placeholder="diametro 2" min="3" max="25" style="width: 90px; height: 20px ;font-size: 16px;"> y
                    <input type="number" id="diametro_3" placeholder="diametro 3" min="3" max="25" style="width: 90px; height: 20px ;font-size: 16px;"> pulgadas, con longitud igual a
                    <input type="number" id="longitud_1" placeholder="longitud 1" min="0" style="width: 90px; height: 20px ;font-size: 16px;">,
                    <input type="number" id="longitud_2" placeholder="longitud 2" min="0" style="width: 90px; height: 20px ;font-size: 16px;">
                    y
                    <input type="number" id="longitud_3" placeholder="longitud 3" min="0" style="width: 90px; height: 20px ;font-size: 16px;"> pies, respectivamente.
                    Se sabe que el caudal es de <input type="number" id="caudal_ej1" placeholder="caudal" style="width: 90px; height: 20px ;font-size: 16px;"> gal/min. Determine la diferencia de altura entre los puntos A y B. Las contracciones son súbitas.
                </p>
                <div style="text-align: center;">
                <img src="d1.png" alt="Image" height="300" width="600">
                </div>
                <label for="ans-0">Respuesta (ft):</label>
                <input type="text" id="ans-0" placeholder="Escribe la respuesta numérica">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>

                <div class="feedback" id="fb-0" aria-live="polite"></div>
                <div class="solution" id="sol-0" style="display:none"></div>
            </section>

            <!-- Ejercicio 2 -->
            <section class="exercise" data-index="1" id="ex-1">
                <h2>Ejercicio 2</h2>
                <p>Por un sistema de dos tuberías en serie circula agua a velocidad constante de V = 2.5 m/s.
                    La presión al inicio es P₁ = 300 kPa, el diametro de la primera sección de tubería es de 76.2 mm y el diametro de la segunda sección es  de 50.8 mm. Calcula la presión final.</p>
                <p><b>Datos:</b><br>
                    L₁ = 40 m<br>
                    L₂ = 25 m<br>
                    f₁ = 0.018<br>
                    f₂ = 0.020<br>
                    rho = 1000 kg/m³<br>
                    g = 9.81 m/s²
                </p>

                <label for="ans-1">Respuesta (kPa):</label>
                <input type="text" id="ans-1" placeholder="Escribe la respuesta numérica">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>

                <div class="feedback" id="fb-1"></div>
                <div class="solution" id="sol-1" style="display:none"></div>
                <div id="retro-1" class="retroalimentacion" style="display:none;"></div>
            </section>

            <!-- Ejercicio 3 -->
            <section class="exercise" data-index="2" id="ex-2">
                <h2>Ejercicio 3</h2>
                <p>Dos tuberías iguales en serie tienen pérdidas h_each = 4 m cada una. ¿Cuál es la pérdida total?</p>

                <label for="ans-2">Respuesta (m):</label>
                <input type="text" id="ans-2" placeholder="Escribe la respuesta numérica">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>

                <div class="feedback" id="fb-2"></div>
                <div class="solution" id="sol-2" style="display:none"></div>
            </section>

            <!-- Ejercicio 4 (nuevo) -->
            <section class="exercise" data-index="3" id="ex-3">
                <h2>Ejercicio 4 — Diámetro requerido (Darcy + Colebrook)</h2>
                <p>
                    Para un sistema de tubería horizontal se requiere definir su diámetro si la caída máxima de presión entre dos puntos separados <b id="L-span">2000</b> ft es de <b id="dP-span">8</b> psi.
                    El flujo volumétrico requerido en el sistema es de <b id="Q-span">2.5</b> ft³/s. La tubería debe ser de cobre tipo K. El fluido es agua a 150°F.
                    (Valores fijos usados: γ=61.2 lb/ft³, ν=4.68e-6 ft²/s, ε=5e-6 ft)
                </p>

                <label for="ans-3">Ingrese su resultado (in):</label>
                <input type="text" id="ans-3" placeholder="Diámetro (in)">

                <div class="controls" style="margin-top:10px;">
                    <!-- Al presionar 'Comprobar' en este ejercicio primero se calculará (ejecutarEj4) y luego se validará -->
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                    <button class="secondary" id="nuevo-4">Generar otro ejercicio</button>
                </div>

                <div class="feedback" id="fb-3" aria-live="polite"></div>
                <div class="solution" id="sol-3" style="display:none; white-space: pre-wrap;"></div>
            </section>


            <!-- Ejercicio 5 (nuevo) -->
            <section class="exercise" data-index="4" id="ex-4">
                <h2>Ejercicio 5: Dos tramos con válvula intermedia</h2>
                <p>Por un sistema de dos tuberías en serie fluye agua a V = 3.0 m/s.  
                    Entre los dos tramos hay una válvula con coeficiente K = 5.  
                    La presión inicial es P₁ = 200 kPa.  
                    Ingrese D₁ y D₂. Calcular la presión final.
                </p>

                <p><b>Datos:</b><br>
                    L₁ = 15 m<br>
                    L₂ = 25 m<br>
                    f₁ = 0.022<br>
                    f₂ = 0.024<br>
                    K = 5<br>
                    ρ = 1000 kg/m³<br>
                    g = 9.81 m/s²
                </p>
                <input id="e5D1" type="number" step="0.001" placeholder="D1 (m)">
                <input id="e5D2" type="number" step="0.001" placeholder="D2 (m)">

                <label for="ans-4">Ingrese su resultado (kPa):</label>
                <input type="text" id="ans-4" placeholder="Presión (kPa)">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>
                <div class="feedback" id="fb-4" aria-live="polite"></div>
                <div class="solution" id="sol-4" style="display:none"></div>
            </section >
            <!-- Ejercicio 6 (nuevo) -->
             <section class="exercise" data-index="5" id="ex-5"> 
                <h2 >Ejercicio 6: Selección del diámetro</h2>
                <p >
                    Para un sistemade tubería horizontal se requiere definir su diámetro
                    si la caída máxima de presión entre dos puntos separados 2000ft es de
                    8psi. El flujo volumétrico requerido en el sistema es de 2.5 ft3/s.
                    La tubería debe ser de cobre tipo K.El fluido es agua a 150°F
                </p>

                <label for="ans-5">Ingrese su resultado (in):</label>
                <input type="text" id="ans-5" placeholder="Diámetro (in)">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>
                <div class="feedback" id="fb-5" aria-live="polite"></div>
                <div class="solution" id="sol-5" style="display:none"></div>
             </section>

             <!-- Ejercicio 7 (nuevo) -->
             <section class="exercise" data-index="6" id="ex-6"> 
                <h2 >Ejercicio 7: Calcular presión inicial</h2>
                <p >
                    En un sistema de tuberías horizontales en serie, la presión final en el punto de salida es de 
                    12 psi.  
                    La pérdida total de presión por fricción y accesorios es de 6.5 psi.  
                    Calcule la presión inicial.
                </p>

                <label for="ans-6">Ingrese su resultado (psi):</label>
                <input type="text" id="ans-6" placeholder="Presión (psi)">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>
                <div class="feedback" id="fb-6" aria-live="polite"></div>
                <div class="solution" id="sol-6" style="display:none"></div>
             </section>

             <!-- Ejercicio 8 (nuevo) -->
             <section class="exercise" data-index="7" id="ex-7"> 
                <h2 >Ejercicio 8: </h2>
                <p >
                    Por dos tuberías en serie inclinadas fluye agua desde un punto inferior hacia un punto superior. La velocidad del flujo es constante e igual a 2.0 m/s.
                    El desnivel entre los puntos es de 8 metros y la presión en el punto inicial es de 250 kPa.
                    Las tuberías tienen las siguientes características:

                    Longitud del primer tramo: L₁ = 20 m

                    Longitud del segundo tramo: L₂ = 35 m

                    Factor de fricción del primer tramo: f₁ = 0.021

                    Factor de fricción del segundo tramo: f₂ = 0.023

                    Densidad del agua: ρ = 1000 kg/m³

                    Aceleración gravitatoria: g = 9.81 m/s²

                    Diámetros fijados: D₁ = 0.050 m y D₂ = 0.080 m

                    Calcular la presión final en el punto superior considerando la pérdida de carga por fricción en ambos tramos y el desnivel geométrico.
                </p>

                <label for="ans-7">Ingrese su resultado (kPa):</label>
                <input type="text" id="ans-7" placeholder="Presión (kPa)">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>
                <div class="feedback" id="fb-7" aria-live="polite"></div>
                <div class="solution" id="sol-7" style="display:none"></div>
             </section>

             <!-- Ejercicio 9 (nuevo) -->
             <section class="exercise" data-index="8" id="ex-8"> 
                <h2 >Ejercicio 9: </h2>
                <p >
                 Por medio del sistema mostrado en la figura se bombea
                    un fluido con densidad relativa igual a 1.29 y viscosidad
                    cinemática de 8.5×10⁻⁵ ft²/s. Las tuberías son de hierro dúctil
                    recubierto de 3 y 4 pulgadas. El flujo volumétrico es de 0.56 ft³/s.
                    Las válvulas a la entrada y salida de la bomba son de globo.
                    La longitud de la tubería de succión es de 5.3 ft y la de la tubería de descarga es de 176 ft. 
                    La diferencia de altura entre el nivel del fluido en el tanque y la salida del fluido del sistema es de 76 ft.
                    Si la bomba tiene un rendimiento del 74%, determine la potencia de entrada a la bomba.
                </p>
                <div style="text-align: center;">
                <img src="ej8.jpg" alt="Image" height="363" width="447">
                </div>
                <label for="ans-8">Ingrese su resultado (W):</label>
                <input type="text" id="ans-8" placeholder="Potencia (W)">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>
                <div class="feedback" id="fb-8" aria-live="polite"></div>
                <div class="solution" id="sol-8" style="display:none"></div>
             </section>
             <!-- Ejercicio 10 (nuevo) -->
             <section class="exercise" data-index="9" id="ex-9"> 
                <h2 >Ejercicio 10: </h2>
                <p >
                    ¿Cuál es el tamaño nominal de una tubería de acero-schedule 40,
                     si su diámetro externo es de 0.840 y su diámetro interno es 21.3?
                </p>
                <label for="ans-9">Ingrese su resultado (in):</label>
                <input type="text" id="ans-9" placeholder="pulgadas(in)">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar solución</button>
                </div>
                <div class="feedback" id="fb-9" aria-live="polite"></div>
                <div class="solution" id="sol-9" style="display:none"></div>
             </section>
        </div>

        <div class="nav">
            <button id="prev">Anterior</button>
            <button id="next">Siguiente</button>
            <div style="flex:1"></div>
            <button id="reset">Reiniciar</button>
        </div>

        <!-- Pantalla de Retroalimentación Final -->
        <div id="final-feedback" style="display:none; text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; margin-top: 20px;">
            <h2 style="font-size: 32px; margin-bottom: 20px;">¡Examen Completado!</h2>
            <div id="score-display" style="font-size: 24px; margin-bottom: 30px;">
                <p>Respuestas Correctas: <span id="correct-count" style="font-weight: bold; color: #4ade80;">0</span></p>
                <p>Respuestas Incorrectas: <span id="incorrect-count" style="font-weight: bold; color: #f87171;">0</span></p>
                <p style="font-size: 28px; margin-top: 20px;">Porcentaje: <span id="percentage-display" style="font-weight: bold; font-size: 36px;">0%</span></p>
            </div>
            <div id="final-message" style="font-size: 20px; margin-bottom: 20px; font-style: italic;"></div>
            <button onclick="location.reload()" style="padding: 12px 24px; background-color: white; color: #667eea; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">Reintentar Examen</button>
        </div>

    </div>

    <script>
/* -------------------------
   TODAS las CONSTANTES
------------------------- */
const temperaturasSI = [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100];
const p_especificoSI = [9.81,9.81,9.81,9.81,9.79,9.78,9.77,9.75,9.73,9.71,9.69,9.67,9.65,9.62,9.59,9.56,9.53,9.50,9.47,9.44,9.40];
const densidadSI = [1000,1000,1000,1000,998,997,996,994,992,990,988,986,984,981,978,975,971,968,965,962,958];
const v_cinematicaSI = [1.75e-6,1.52e-6,1.30e-6,1.15e-6,1.02e-6,8.94e-7,8.03e-7,7.22e-7,6.56e-7,6.00e-7,5.48e-7,5.05e-7,4.67e-7,4.39e-7,4.11e-7,3.83e-7,3.60e-7,3.41e-7,3.22e-7,3.04e-7,2.94e-7];

const temperaturasIN = [32,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,212];
const p_especificoIN = [62.4,62.4,62.4,62.4,62.3,62.2,62.1,62.0,61.9,61.7,61.5,61.4,61.2,61.0,60.8,60.6,60.4,60.1,59.8];
const densidadIN = [1.94,1.94,1.94,1.94,1.94,1.93,1.93,1.93,1.92,1.92,1.91,1.91,1.90,1.90,1.89,1.88,1.88,1.87,1.86];
const v_cinematicaIN = [1.89e-5,1.67e-5,1.40e-5,1.21e-5,1.05e-5,9.15e-6,8.29e-6,7.37e-6,6.55e-6,5.94e-6,5.49e-6,5.03e-6,4.68e-6,4.38e-6,4.07e-6,3.84e-6,3.62e-6,3.35e-6,3.17e-6];

const g = 32.17;
const rho = 1000;
const rug_HDR_IN = 0.0004;

const K_contraccion = {
  "2_pies_s":[0.00,0.03,0.07,0.17,0.26,0.34,0.38,0.40,0.42,0.44,0.47,0.48,0.49],
  "4_pies_s":[0.00,0.04,0.07,0.17,0.26,0.34,0.37,0.40,0.42,0.44,0.46,0.47,0.48],
  "6_pies_s":[0.00,0.04,0.07,0.17,0.26,0.34,0.37,0.39,0.41,0.43,0.45,0.47,0.48],
  "8_pies_s":[0.00,0.04,0.08,0.18,0.26,0.33,0.36,0.39,0.40,0.42,0.44,0.45,0.47],
  "10_pies_s":[0.00,0.05,0.08,0.18,0.26,0.33,0.36,0.38,0.40,0.42,0.45,0.46,0.47],
  "15_pies_s":[0.00,0.05,0.08,0.18,0.25,0.32,0.34,0.37,0.38,0.40,0.45,0.45,0.47],
  "20_pies_s":[0.00,0.05,0.09,0.18,0.25,0.31,0.33,0.35,0.37,0.39,0.46,0.47,0.47],
  "30_pies_s":[0.00,0.06,0.10,0.19,0.25,0.29,0.32,0.33,0.34,0.36,0.46,0.47,0.40],
  "40_pies_s":[0.00,0.06,0.11,0.20,0.24,0.27,0.29,0.30,0.31,0.33,0.38,0.40,0.38]
};

const claves = ["2_pies_s","4_pies_s","6_pies_s","8_pies_s","10_pies_s","15_pies_s","20_pies_s","30_pies_s","40_pies_s"];
const claves_value = [2,4,6,8,10,15,20,30,40];
const D1_D2 = [1.0,1.1,1.2,1.4,1.6,1.8,2.0,2.2,2.5,3.0,4.0,5.0,10.0];
let Za_correct = null;

/* -------------------------
   Funciones auxiliares
------------------------- */
function velocity(caudal, d1, d2, d3){
    let v1 = caudal*0.00222801 / (((d1/12)**2)*Math.PI/4);
    let v2 = caudal*0.00222801 / (((d2/12)**2)*Math.PI/4);
    let v3 = caudal*0.00222801 / (((d3/12)**2)*Math.PI/4);
    return {v1, v2, v3};
}

function subindice_inferior(lista, valor){
    if (valor < lista[0]) return 0;
    for (let i=0;i<lista.length;i++){
        if (lista[i] > valor) return i-1;
        if (lista[i] === valor) return i;
    }
    return lista.length - 1;
}

function subindice_superior(lista, valor){
    if (valor <= lista[0]) return 0;
    for (let i=0;i<lista.length;i++){
        if (lista[i] >= valor) return i;
    }
    return lista.length - 1;
}

function interpolacion(x0,y0,x1,y1,x){
    if (x0 == x1){
        return y0;
    }

    if (x0 != x1){
        let int = y0 + ((y1-y0)/(x1-x0))*(x-x0);
        return int;
    }

}

function factorf(d, Re){
    if (Re < 2000) return 64/Re;
    return 0.25 / (Math.log10(rug_HDR_IN/(3.7*(d/12)) + 5.74/(Re**0.9))**2);
}

function losses(f, L, v, d){
    return f * (L/(d/12)) * (v**2/(2*g));
}

function contractionlosses(k, v){
    return k*(v**2)/(2*g);
}

let solucionfinal1 ="";
/* ---------------------------------------------------------
  FUNCIÓN EJECUTAR EJERCICIO 1
--------------------------------------------------------- */
function ejecutarEj1(){
    let Q_ej1 = parseFloat(document.getElementById('caudal_ej1').value);
    let d1 = parseFloat(document.getElementById('diametro_1').value);
    let d2 = parseFloat(document.getElementById('diametro_2').value);
    let d3 = parseFloat(document.getElementById('diametro_3').value);
    let T = parseFloat(document.getElementById('temperature').value);
    let L1 = parseFloat(document.getElementById('longitud_1').value);
    let L2 = parseFloat(document.getElementById('longitud_2').value);
    let L3 = parseFloat(document.getElementById('longitud_3').value);

    if (isNaN(Q_ej1)||isNaN(d1)||isNaN(d2)||isNaN(d3)||T<32||d1<d2||d2<d3){
        alert("Datos inválidos.");
        return;
    }

    const velocidades = velocity(Q_ej1, d1, d2, d3);

    let si = subindice_inferior(temperaturasIN, T);
    let ss = subindice_superior(temperaturasIN, T);

    let vis_inf = v_cinematicaIN[si];
    let vis_sup = v_cinematicaIN[ss];
    let T_inf = temperaturasIN[si];
    let T_sup = temperaturasIN[ss];

    let visc;
    if (T_inf===T_sup) visc = vis_inf;
    else visc = vis_inf + ((vis_sup-vis_inf)/(T_sup-T_inf))*(T-T_inf);

    let r1 = d1/d2;
    let r2 = d2/d3;
    // limitar la relacion entre los diametros. Esto es: si r1> 10{ r1 = 10} igualmente con r2
    if (r1 > 10){
        r1 = 10;
    }
    if (r2 > 10){{
        r2 = 10;
    }}
    const v1 = velocidades.v1;
    const v2 = velocidades.v2;
    const v3 = velocidades.v3;
    // K1 //
    let si_v2 = subindice_inferior(claves_value, v2);   // Subindice inferior velocidad 2
    let ss_v2 = subindice_superior(claves_value, v2);      // subindice superior velocidad 2

    let si_rA = subindice_inferior(D1_D2, r1);          // subindice inferior razon de diametros A
    let ss_rA = subindice_superior(D1_D2, r1);          // Subindice superior razon de diametrs A

    let K1_i_i = K_contraccion[claves[si_v2]][si_rA];   // K1  inferior izquierdo
    let K1_s_i = K_contraccion[claves[ss_v2]][ss_rA];   // K1  superior izquierdo

    let K1_i_d = K_contraccion[claves[Math.min(si_v2+1,claves.length-1)]][si_rA];       // K1 inferior derecho
    let K1_s_d = K_contraccion[claves[Math.min(ss_v2+1,claves.length-1)]][ss_rA];       // k2 superior derecho

    let K1_inf = interpolacion(claves_value[si_v2],K1_i_i,claves_value[Math.min(si_v2+1,claves.length-1)],K1_i_d,v2);   // Interpolando
    let K1_sup = interpolacion(claves_value[ss_v2],K1_s_i,claves_value[Math.min(ss_v2+1,claves.length-1)],K1_s_d,v2);   // Interpolando
    let K1 = interpolacion(D1_D2[si_rA],K1_inf,D1_D2[ss_rA],K1_sup,r1);


    /* ---- K2 ---- */
    let si_v3 = subindice_inferior(claves_value, v3);
    let ss_v3 = subindice_superior(claves_value, v3);

    let si_rB = subindice_inferior(D1_D2, r2);
    let ss_rB = subindice_superior(D1_D2, r2);

    let K2_i_i = K_contraccion[claves[si_v3]][si_rB];
    let K2_s_i = K_contraccion[claves[ss_v3]][ss_rB];

    let K2_i_d = K_contraccion[claves[Math.min(si_v3+1,claves.length-1)]][si_rB];
    let K2_s_d = K_contraccion[claves[Math.min(ss_v3+1,claves.length-1)]][ss_rB];

    let K2_inf = interpolacion(claves_value[si_v3],K2_i_i,claves_value[Math.min(si_v3+1,claves.length-1)],K2_i_d,v3);
    let K2_sup = interpolacion(claves_value[ss_v3],K2_s_i,claves_value[Math.min(ss_v3+1,claves.length-1)],K2_s_d,v3);
    let K2 = interpolacion(D1_D2[si_rB],K2_inf,D1_D2[ss_rB],K2_sup,r2);

    let Re1 = v1*(d1/12)/visc;
    let Re2 = v2*(d2/12)/visc;
    let Re3 = v3*(d3/12)/visc;

    let f1 = factorf(d1, Re1);
    let f2 = factorf(d2, Re2);
    let f3 = factorf(d3, Re3);

    let h1 = losses(f1, L1, v1, d1);
    let h2 = losses(f2, L2, v2, d2);
    let h3 = losses(f3, L3, v3, d3);

    let hc1 = contractionlosses(K1, v2);
    let hc2 = contractionlosses(K2, v3);

    let hvB = (v3**2)/(2*g);

    Za_correct = h1 + h2 + h3 + hvB + hc1 + hc2;
    
    solucionfinal1 =`
## Datos Calculados:

<p>Teniendo el caudal ($Q$) y el diámetro ($D$) de cada tubería, la velocidad se calcula con la siguiente relación:</p>

$$ v = \\frac{Q}{A} = \\frac{4Q}{\\pi D^2} $$

<p>Velocidades de la sección:</p>
<ul>
    <li>$v_1 = ${v1} \\text{ ft/s}$</li>
    <li>$v_2 = ${v2} \\text{ ft/s}$</li>
    <li>$v_3 = ${v3} \\text{ ft/s}$</li>
</ul>

---

### Número de Reynolds ($Re$)

<p>Viscosidad cinemática en base a la temperatura:</p>
$$ \\nu = ${visc} \\text{ } \\frac{ft^2}{s} $$

<p>El número de Reynolds se calcula como: $Re = \\frac{vD}{\\nu}$. Donde $\\nu$ es la viscosidad cinemática.</p>

<ul>
    <li>$Re_1 = ${Re1}$</li>
    <li>$Re_2 = ${Re2}$</li>
    <li>$Re_3 = ${Re3}$</li>
</ul>

---

### Factor de Fricción

<p>La rugosidad para este problema es de: $\\epsilon = ${rug_HDR_IN} \\text{ ft}$</p>
<p>Factor de fricción ($f$) calculado con la ecuación de Swamee-Jain:</p>

$$ \\frac{1}{\\sqrt{f}} = -2 \\log \\left( \\frac{\\epsilon/D}{3.7} + \\frac{2.51}{Re \\sqrt{f}} \\right) $$

<ul>
    <li>$f_1 = ${f1}$</li>
    <li>$f_2 = ${f2}$</li>
    <li>$f_3 = ${f3}$</li>
</ul>

---

### Pérdidas por Fricción ($h_l$) y Contracción ($h_c$)

<p>Pérdidas por fricción en cada sección empleando la ecuación de Darcy-Weisbach:</p>

$$ h_l = f \\left( \\frac{L}{D} \\right) \\frac{v^2}{2g} $$

<ul>
    <li>$h_{l1} = ${h1} \\text{ ft}$</li>
    <li>$h_{l2} = ${h2} \\text{ ft}$</li>
    <li>$h_{l3} = ${h3} \\text{ ft}$</li>
</ul>

<p>Constantes $K$ interpoladas de las tablas para contracciones súbitas:</p>
<ul>
    <li>$K_1 = ${K1}$</li>
    <li>$K_2 = ${K2}$</li>
</ul>

<p>Pérdidas por contracciones súbitas, donde $h_c = K \\frac{v^2}{2g}$:</p>
<ul>
    <li>$h_{c1} = ${hc1} \\text{ ft}$</li>
    <li>$h_{c2} = ${hc2} \\text{ ft}$</li>
</ul>

---

## Resultado Final

<p>La diferencia de cotas ($Z_A - Z_B$) es igual a la suma de todas las pérdidas (fricción y accesorios):</p>

$$ Z_A - Z_B = \\sum h_{l} + \\sum h_{c} $$

$$ Z_A - Z_B = ${Za_correct} \\text{ ft} $$
`;
    problems[0] = { answer: ()=>Za_correct, solution: solucionfinal1 };  

    // mostrar solución condensada en sol-1 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-0').textContent = solucionfinal2;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-0').style.display = "none";
}

// EJECUTAR EJERCICIO 2
let solucionfinal2 ="";
function ejecutarEj2(){
    solucionfinal2 = `
<p>Se calculan las pérdidas por fricción en cada tramo con la ecuación de Darcy-Weisbach:</p>

$$ h_l = f \\left( \\frac{L}{d} \\right) \\frac{v^2}{2g} $$

<ul>
    <li>Pérdidas tramo 1 ($h_{l1}$) = 3.01 \\text{ m}</li>
    <li>Pérdidas tramo 2 ($h_{l2}$) = 3.14 \\text{ m}</li>
</ul>

<p>Se hallan las pérdidas totales ($h_t$):</p>

$$ h_t = h_{l1} + h_{l2} = 3.01 + 3.14 = 6.15 \\text{ m} $$

<p>Se halla el cambio de presión (\\(\\Delta P\\)) usando la ecuación de energía simplificada:</p>

$$ \\Delta P = \\rho g h_t $$

<p>Sustituyendo los valores $(\\rho \\approx 1000 \\text{ kg/m}^3, g = 9.81 \\text{ m/s}^2, h_t = 6.15 \\text{ m})$:</p>

$$ \\Delta P = 1000(9.81)(6.15) \\approx 60300 \\text{ Pa} = 60.3 \\text{ kPa} $$

<p>Finalmente, la presión a la salida ($P_2$) es la presión inicial ($P_1$) menos la pérdida de presión:</p>

$$ P_2 = 300 \\text{ kPa} - 60.3 \\text{ kPa} = 239.7 \\text{ kPa} $$
`;
    problems[1] = { answer: ()=>239.7, solution: solucionfinal2 };  

    // mostrar solución condensada en sol-1 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-1').textContent = solucionfinal2;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-1').style.display = "none";
}
/* -------------------------
   EJERCICIO 4: Darcy + Colebrook (aleatorio)
   - genera Q, dP, L en los rangos pedidos
   - itera para obtener D y f
   - selecciona diámetro comercial (tabla usada previamente)
   - actualiza problems[3] para que checkAnswer lo use
------------------------- */

let diaComercial_in = null; // valor a comparar en pulgadas (se actualizará)
let ultimaSolucionText = ''; // texto detallado de la solución (para mostrar)

function aleatorio(min, max){
    return Math.random()*(max-min)+min;
}

function ejecutarEj4(){
    // Rangos pedidos
    let Q = parseFloat(aleatorio(1.5,3).toFixed(4)); // ft3/s
    let deltaP = parseFloat(aleatorio(8,15).toFixed(3)); // psi
    let L = parseFloat(aleatorio(1500,3000).toFixed(0)); // ft

    // mostrar en el enunciado los valores actuales
    document.getElementById('Q-span').textContent = Q;
    document.getElementById('dP-span').textContent = deltaP;
    document.getElementById('L-span').textContent = L;

    // Propiedades fijas
    const gamma = 61.2; // lb/ft3
    const nu = 4.68e-6; // ft2/s
    const eps = 5e-6; // ft
    const g_local = 32.17; // ft/s2

    // convertir diferencia de presion a altura (ft)
    const h = (deltaP * 144) / gamma; // ft

    // Iteración: usamos esquema similar al que describiste
    // Partimos con f inicial y D inicial (ft)
    let f = 0.02;
    let D = 0.6; // ft
    let D_new = D;
    let iter = 0;

    while(iter < 200){
        // ecuación (1): D = [ f * (8 L Q^2) / (pi^2 g h) ]^(1/5)
        D_new = Math.pow( f * (8 * L * Q * Q) / (Math.PI*Math.PI * g_local * h), 1/5 );

        // Reynolds (usando Re = 4Q/(pi D nu))
        let Re = (4 * Q) / (Math.PI * D_new * nu);

        // Actualizar f usando aproximación implícita de Colebrook (punto fijo)
        // 1/sqrt(f) = -2 log10( eps/(3.7D) + 2.51/(Re sqrt(f)) )
        let rhs = -2 * Math.log10( eps/(3.7*D_new) + 2.51/(Re * Math.sqrt(f)) );
        let f_new = 1.0 / (rhs * rhs);

        // relajación para estabilidad
        f = 0.6*f + 0.4*f_new;

        // chequeo de convergencia
        if (Math.abs(D_new - D) < 1e-7 && Math.abs(f_new - f) < 1e-8) break;

        D = D_new;
        iter++;
    }

    // resultado final
    let D_ft = D_new;
    let D_in = D_ft * 12;

    // Tabla comercial utilizada (la misma que usamos antes)
    const tabla_comercial_in = [0.5,0.75,1,1.25,1.5,2,2.5,3,4,6,8,10,12];

    // elegir el menor diámetro comercial >= D_in (por exceso)
    diaComercial_in = tabla_comercial_in.find(d => d >= D_in) || tabla_comercial_in[tabla_comercial_in.length-1];

    // preparar texto de solución detallada
    ultimaSolucionText = `
## Datos Generados:

<ul>
    <li>Caudal (Q) = ${Q.toFixed(4)} \\text{ ft}^3/\\text{s}</li>
    <li>Caída de presión (\\(\\Delta P\\)) = ${deltaP.toFixed(3)} \\text{ psi}</li>
    <li>Longitud (L) = ${L} \\text{ ft}</li>
</ul>

### Propiedades del Fluido y Tubería:

<ul>
    <li>Peso específico (\\(\\gamma\\)) = ${gamma} \\text{ lb/ft}^3</li>
    <li>Viscosidad cinemática (\\(\\nu\\)) = ${nu} \\text{ ft}^2/\\text{s}</li>
    <li>Rugosidad absoluta (\\(\\epsilon\\)) = ${eps} \\text{ ft}</li>
</ul>

---

## Proceso de Iteración (Ecuación de Darcy-Colebrook)

<p>La solución requiere iterar para hallar el diámetro ($D$), utilizando una versión modificada de la Ecuación de Darcy-Weisbach y la Ecuación de Colebrook-White. El diámetro se obtiene implícitamente de la relación:</p>

$$ \\Delta P = f \\left( \\frac{L}{D} \\right) \\frac{\\rho v^2}{2} $$

<p>El proceso convergió después de ${iter} \\text{ iteraciones}.</p>

### Resultados de la Iteración:

<ul>
    <li>Diámetro calculado ($D$) $\\approx ${D_ft.toFixed(6)} \\text{ ft}$ ($\\approx ${D_in.toFixed(4)} \\text{ in}$)</li>
    <li>Factor de fricción ($f$) $\\approx ${f.toFixed(6)}</li>
    <li>Número de Reynolds ($Re$) $\\approx ${( (4*Q)/(Math.PI *D_ft*nu) ).toExponential(3)}</li>
</ul>

---

## Diámetro Comercial Seleccionado

<p>Diámetro comercial seleccionado (por exceso):</p>
$$ D_{\\text{comercial}} = ${diaComercial_in} \\text{ in} $$
`;

    // Actualizar objeto problems[3] para que checkAnswer lo use
    if (problems.length < 4){
        problems[3] = { answer: ()=>diaComercial_in, solution: ultimaSolucionText };
    } else {
        problems[3].answer = ()=>diaComercial_in;
        problems[3].solution = ultimaSolucionText;
    }

    // mostrar solución condensada en sol-3 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-3').textContent = ultimaSolucionText;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-3').style.display = "none";

    // devolver el valor calculado para uso inmediato (si se desea)
    return {D_ft, D_in, diaComercial_in, f, ultimaSolucionText};
}
// FUNCIÓN EJECUTAR EJERCICIO 5
let solucionfinal5 = "";
function ejecutarEj5(){
    let D1 = parseFloat(e5D1.value);
    let D2 = parseFloat(e5D2.value);
    if(!D1 || !D2) return alert("Ingrese los diámetros");

    let L1=15, L2=25, f1=0.022, f2=0.024, V=3.0, P1=200, K=5;

    let hf1 = f1*(L1/D1)*(V*V/(2*g));
    let hf2 = f2*(L2/D2)*(V*V/(2*g));
    let hv = K*(V*V/(2*g));
    let hf = hf1 + hf2 + hv;
    let P3 = P1 - (rho*g*hf)/1000;

    solucionfinal5 = `
## Cálculo Paso a Paso de Pérdidas de Carga

### 1. Pérdidas por Fricción (Darcy-Weisbach)

<p>La pérdida por fricción se calcula con la ecuación:</p>

$$ h_f = f \\left( \\frac{L}{D} \\right) \\frac{V^2}{2g} $$

<p><strong>Pérdida en el tramo 1 (hf1):</strong></p>
$$ h_{f1} = ${f1} \\cdot \\left( \\frac{${L1}}{${D1}} \\right) \\cdot \\frac{${V}^2}{2 \\cdot ${g}} $$
<p class="mt-2">Resultado: $h_{f1} = ${hf1.toFixed(4)} \\text{ m}$</p>

<p><strong>Pérdida en el tramo 2 (hf2):</strong></p>
$$ h_{f2} = ${f2} \\cdot \\left( \\frac{${L2}}{${D2}} \\right) \\cdot \\frac{${V}^2}{2 \\cdot ${g}} $$
<p class="mt-2">Resultado: $h_{f2} = ${hf2.toFixed(4)} \\text{ m}$</p>

---

### 2. Pérdida en la Válvula (Accesorios)

<p>La pérdida en la válvula se calcula usando el coeficiente de pérdida $K$:</p>

$$ h_v = K \\frac{V^2}{2g} $$

$$ h_v = ${K} \\cdot \\frac{${V}^2}{2 \\cdot ${g}} $$
<p class="mt-2">Resultado: $h_v = ${hv.toFixed(4)} \\text{ m}$</p>

---

### 3. Pérdida Total y Presión Final

<p>La pérdida total ($h_f$) es la suma de todas las pérdidas de carga:</p>

$$ h_f = h_{f1} + h_{f2} + h_v = ${hf1.toFixed(4)} + ${hf2.toFixed(4)} + ${hv.toFixed(4)} = ${hf.toFixed(4)} \\text{ m} $$

<p>La presión final ($P_3$) se calcula aplicando la ecuación de Bernoulli entre el punto inicial ($P_1$) y el final ($P_3$):</p>

$$ P_3 = P_1 - \\rho g h_f $$

<p>Resultado:</p>
$$ P_3 = ${P3.toFixed(2)} \\text{ kPa} $$
`;

    // Actualizar objeto problems[4] para que checkAnswer lo use
    
    problems[4] = { answer: ()=>P3, solution: solucionfinal5 };
  

    // mostrar solución condensada en sol-3 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-4').textContent = solucionfinal5;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-4').style.display = "none";

    }
//FUNCIÓN EJERCICIO 6
let solucionfinal6 ="";
function ejecutarEj6(){
    let answer = 0.375;
    solucionfinal6 = `
## Solución del Problema de Caída de Presión Máxima

### 1. Condición de Restricción

<p>Se conoce la caída máxima de presión permitida:</p>
$$ \\Delta P_{\\text{máx}} = 8 \\text{ psi} $$

### 2. Análisis del Sistema

Para el caudal dado ($2.5 \\text{ ft}^3/\\text{s}$) y las características del tubo de cobre Tipo K, se evalúan los diámetros comerciales disponibles en el mercado.

### 3. Diámetro Seleccionado

Al analizar las pérdidas y el comportamiento hidráulico, se determina que el único diámetro que satisface la condición de $\\leq 8 \\text{ psi}$ es:

$$ D = \\frac{3}{8} \\text{ in} = 0.375 \\text{ in} $$

### 4. Conclusión

Por lo tanto, $0.375 \\text{ in}$ es el diámetro seleccionado para cumplir la restricción de presión.
`;
    // Actualizar objeto problems[4] para que checkAnswer lo use
    problems[5] = { answer: ()=>answer, solution: solucionfinal6 };
    

    // mostrar solución condensada en sol-5 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-5').textContent = ultimaSolucionText;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-5').style.display = "none";
}
// FUNCIÓN EJERCICIO 7
let solucionfinal7 ="";
function ejecutarEj7(){
    answer = 18.5;
    solucionfinal7 = `
    Pérdida de presión = 6.5 psi
    Presión Final = 12 psi
    
    P1 = P2 + Pérdida de presión
    P1 = 12 psi + 6.5 psi = 18.5 psi
    `;
    // Actualizar objeto problems[4] para que checkAnswer lo use
    problems[6] = { answer: ()=>answer, solution: solucionfinal7 };
    
     // mostrar solución condensada en sol-6 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-6').textContent = solucionfinal7;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-6').style.display = "none";
}

//FUNCIÓN EJECUTAR EJERCICIO 8
let solucionfinal8 = "";
function ejecutarEj8(){
    let answer = 134.60
    solucionfinal8 = `
## Cálculo Paso a Paso de Pérdidas de Carga

### 1. Cálculo del Término Constante $T$

<p>La velocidad ($V$) es la misma en ambos tramos y la gravedad ($g$) es constante. Por lo tanto, el término de velocidad es idéntico y se calcula una sola vez:</p>

$$ T = \\frac{V^2}{2g} $$

<p>Sustituyendo el valor de la velocidad ($V = 2.0 \\text{ m/s}$) y la gravedad ($g = 9.81 \\text{ m/s}^2$):</p>

$$ T = \\frac{2.0^2}{2 \\cdot 9.81} \\approx 0.2038736 \\text{ m} $$

---

### 2. Pérdidas por Fricción ($h_f$)

<p>La pérdida por fricción en cada tramo es:</p>

$$ h_f = f \\left( \\frac{L}{D} \\right) T $$

<ul>
    <li>
        <strong>Tramo 1 ($h_{f1}$):</strong>
        $$ h_{f1} = f_1 \\left( \\frac{L_1}{D_1} \\right) T $$
        $$ h_{f1} = 0.021 \\left( \\frac{20}{0.050} \\right) (0.2038736) \\approx 1.7125382 \\text{ m} $$
    </li>
    <li>
        <strong>Tramo 2 ($h_{f2}$):</strong>
        $$ h_{f2} = f_2 \\left( \\frac{L_2}{D_2} \\right) T $$
        $$ h_{f2} = 0.023 \\left( \\frac{35}{0.080} \\right) (0.2038736) \\approx 2.0514781 \\text{ m} $$
    </li>
</ul>

### 3. Pérdida Total y Altura Equivalente

<p><strong>Pérdida por fricción total:</strong></p>
$$ h_f = h_{f1} + h_{f2} \\approx 1.7125382 + 2.0514781 \\approx 3.7640163 \\text{ m} $$

<p><strong>Altura total equivalente ($h_{\\text{total}}$):</strong></p>
<p>Se asume que la altura total incluye una altura inicial $h=8 \\text{ m}$ más las pérdidas por fricción:</p>
$$ h_{\\text{total}} = h + h_f = 8 + 3.7640163 \\approx 11.7640163 \\text{ m} $$

---

### 4. Caída de Presión ($\Delta P$) y Presión Final

<p>La caída total de presión es $\\Delta P = \\rho g h_{\\text{total}}$, donde $\\rho = 1000 \\text{ kg/m}^3$ y $g = 9.81 \\text{ m/s}^2$:</p>
$$ \\Delta P = 1000 (9.81) (11.7640163) \\approx 115405 \\text{ Pa} = 115.405 \\text{ kPa} $$

<p><strong>Presión final ($P_2$):</strong></p>
$$ P_2 = P_1 - \\Delta P $$
$$ P_2 = 250 \\text{ kPa} - 115.405 \\text{ kPa} \\approx 134.595 \\text{ kPa} \\approx 134.60 \\text{ kPa} $$
`;
    // Actualizar objeto problems[7] para que checkAnswer lo use
    problems[7] = { answer: ()=>answer, solution: solucionfinal8 };
    
     // mostrar solución condensada en sol-6 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-7').textContent = solucionfinal8;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-7').style.display = "none";
}

let solucionfinal9 ="";
function ejecutarEj9(){
    let answer = 7077.3127;
    solucionfinal9 = `
Para la resolución del ejercicio partimos desde la ecuación de la energía, tomando un nivel de referencia desde el nivel de la tubería de succión. De esta forma, podemos despejar la carga generada por la bomba, componente fundamental para determinar la potencia de la bomba:
Carga de la Bomba = Diferencia de altura   +  Pérdidas   +   ((Velocidad de descarga) ^2 )/ 2

Las pérdidas estarán presentes a los tramos rectos y a los accesorios, es decir, al codo de 90° estándar y a las 2 válvulas de globo.
Al realizar el calculo las perdidas dan -->
Perdidas = 38.7079 ft

Luego se reemplaza en la ecuación -->
Carga de la Bomba = 116.0552

Por ende => 
•	La potencia efectiva de la bomba = 5237.2114
•	La potencia en el eje de la bomba = 7077.3127
`; 

    // Actualizar objeto problems[8] para que checkAnswer lo use
    problems[8] = { answer: ()=>answer, solution: solucionfinal9 };
    
     // mostrar solución condensada en sol-8 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-8').textContent = solucionfinal9;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-8').style.display = "none";

}
// EJERCICIO 10
solucionfinal10 ="";
function ejecutarEj10(){
    let answer = 0.5 ;
    solucionfinal10 = "Buscar en tablas";

     // Actualizar objeto problems[9] para que checkAnswer lo use
    problems[9] = { answer: ()=>answer, solution: solucionfinal10 };
    
     // mostrar solución condensada en sol-9 (oculta por defecto; sólo se muestra cuando hay error o Show solution)
    document.getElementById('sol-9').textContent = solucionfinal10;
    // no forzar display:block aquí para no tapar el input
    document.getElementById('sol-9').style.display = "none";

}
/* -------------------------
   CONTADOR DE RESPUESTAS CORRECTAS E INCORRECTAS
------------------------- */
let correctAnswers = 0;
let incorrectAnswers = 0;
const totalExercises = 10;

/* -------------------------
   PROBLEMAS Y CHECKEO
   (agregamos placeholder en index 3; se actualizará en ejecutarEj4)
------------------------- */
let problems = [
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 1 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 2 (aún no generada)." },
    { answer: ()=>8,         solution: "h_total = hl1 + hl2 = 8 m" },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 4 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 5 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 6 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 7 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 7 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 7 (aún no generada)." },
    { answer: ()=>{ return null; }, solution: "Solución del Ejercicio 7 (aún no generada)." }
];

/* -------------------------
   Navegación
------------------------- */
let current = 0;
const exerciseEls = document.querySelectorAll('.exercise');

function showExercise(i){
    exerciseEls.forEach((el,idx)=>el.classList.toggle("active", idx===i));
    current = i;
}

document.getElementById("prev").onclick = () => showExercise(Math.max(0,current-1));
document.getElementById("next").onclick = () => showExercise(Math.min(exerciseEls.length-1,current+1));

document.getElementById("reset").onclick = () => {
    for(let i=0;i<exerciseEls.length;i++){
        let ansEl = document.getElementById("ans-"+i);
        if(ansEl) ansEl.value="";
        let fbEl = document.getElementById("fb-"+i);
        if(fbEl) fbEl.textContent="";
        let solEl = document.getElementById("sol-"+i);
        if(solEl) solEl.style.display="none";
        let r = document.getElementById("retro-"+i);
        if(r) r.style.display="none";
    }
    showExercise(0);
};

/* -------------------------
   Eventos de botones (un solo listener)
------------------------- */
document.getElementById("exercises").addEventListener("click", e=>{
    let action = e.target.getAttribute("data-action");
    if (!action) return;

    let section = e.target.closest(".exercise");
    let idx = Number(section.dataset.index);

    // si es el ejercicio 0 y pulsaron Comprobar, ejecuta su cálculo especial
    if (idx === 0 && action === "check") {
        ejecutarEj1();  // botón azul del Ej1
        // permitir que luego checkAnswer(0) sea llamado más abajo
    }

     // si es el ejercicio 1 y pulsaron Comprobar, ejecuta su cálculo especial
    if (idx === 1 && action === "check") {
        ejecutarEj2();  // botón azul del Ej2
        // permitir que luego checkAnswer(0) sea llamado más abajo
    }

    // si es el ejercicio 3 y pulsaron Comprobar, primero generamos/ejecutamos y actualizamos la respuesta correcta
    if (idx === 3 && action === "check") {
        ejecutarEj4();
        // ahora problems[3] fue actualizado con la solución 
    }
    // si es el ejercicio 4 y pulsaron Comprobar, primero generamos/ejecutamos y actualizamos la respuesta correcta
    if (idx === 4 && action === "check") {
        ejecutarEj5();
        // ahora problems[4] fue actualizado con la solución 
    }
    // si es el ejercicio 5 y pulsaron Comprobar, primero generamos/ejecutamos y actualizamos la respuesta correcta
    if (idx === 5 && action === "check") {
        ejecutarEj6();
        // ahora problems[5] fue actualizado con la solución 
    }
    if (idx === 6 && action === "check") {
        ejecutarEj7();
        // ahora pr oblems[6] fue actualizado con la solución 
    }
    if (idx === 7 && action === "check") {
        ejecutarEj8();
        // ahora pr oblems[7] fue actualizado con la solución 
    }
    if (idx === 8 && action === "check") {
        ejecutarEj9();
        // ahora pr oblems[8] fue actualizado con la solución 
    }
    if (idx === 9 && action === "check") {
        ejecutarEj10();
        // ahora pr oblems[9] fue actualizado con la solución 
    }
    // ahora el comportamiento general
    if (action === "check") checkAnswer(idx);
    if (action === "show-solution") showSolution(idx);
});

// botón separado para generar otro ejercicio 4 (sin comprobar)
document.getElementById("nuevo-4").addEventListener("click", function(){
    ejecutarEj4();
    // limpiar el input y feedback
    let ans = document.getElementById("ans-3");
    if (ans) ans.value = "";
    let fb = document.getElementById("fb-3");
    if (fb) { fb.textContent = ""; fb.className = "feedback"; }
    // mantener la solución oculta
    document.getElementById('sol-3').style.display = "none";
});

/* -------------------------
   Eventos comunes y utilidades
------------------------- */

function normalizeNumberInput(v){
    return Number(String(v).trim().replace(",","."));
}

function checkAnswer(i){
    let input = document.getElementById("ans-"+i);
    let fb = document.getElementById("fb-"+i);
    let sol = document.getElementById("sol-"+i);

    // si no existe input (ej. ejercicios sin respuesta escrita) salir
    if (!input || !fb || !sol){
        return;
    }

    let val = normalizeNumberInput(input.value);

    let correct = (typeof problems[i].answer === "function")
                    ? problems[i].answer()
                    : problems[i].answer;

    if (correct === null || typeof correct === "undefined"){
        fb.textContent="Aún no hay solución generada para este ejercicio.";
        fb.className="feedback error";
        return;
    }

    if (isNaN(val)){
        fb.textContent="Número inválido.";
        fb.className="feedback error";
        return;
    }

    let errorPermitido = 0.05; // 5%

    if (Math.abs(val - correct) <= Math.abs(correct)*errorPermitido){
        fb.textContent="Correcto ✔";
        fb.className="feedback success";
        sol.style.display="none";

        // CONTAR RESPUESTA CORRECTA (solo si es la primera vez)
        if (!input.dataset.isCorrect) {
            input.dataset.isCorrect = "1";
            correctAnswers++;
            checkIfAllAnswered();
        }

        // ---------------------------
        // 🔵 REGISTRAR RESPUESTA EN FIREBASE
        // ---------------------------
        (async () => {
            try {
                const nombre = document.getElementById("nombre_estudiante").value || "Sin nombre";
                const primerIntento = !input.dataset.fallado;  // si nunca falló antes

                await addDoc(collection(db, "respuestas"), {
                    nombre: nombre,
                    ejercicio: i,
                    respuestaIngresada: val,
                    correcta: true,
                    primerIntento: primerIntento,
                    fecha: new Date().toISOString()
                });

                console.log("Guardado en Firestore");
            } catch (err) {
                console.error("Error al guardar:", err);
            }
        })();

        fb.className="feedback success";
        sol.style.display="none";
   } else {
        fb.textContent="Incorrecto ✘";
        input.dataset.fallado = "1";
        fb.className="feedback error";

        // CONTAR RESPUESTA INCORRECTA (solo si aún no era incorrecta)
        if (!input.dataset.isIncorrect) {
            input.dataset.isIncorrect = "1";
            incorrectAnswers++;
            checkIfAllAnswered();
        }

        // *** CAMBIO CLAVE 1: USAR innerHTML ***
        // Nota: Asegúrate de que problems[i].solution ya contenga el string LaTeX que creamos.
        sol.innerHTML = `<b>Solución (valor):</b> ${correct.toFixed(3)} <br><br> ${problems[i].solution}`;
        sol.style.display="block";

        // *** CAMBIO CLAVE 2: FORZAR RENDERIZADO DE MATHJAX ***
        // Esto le dice a MathJax que revise el contenido del div 'sol'.
        if (window.MathJax) {
            MathJax.typesetPromise([sol]);
        }
    }
}

function checkIfAllAnswered() {
    const totalAnswered = correctAnswers + incorrectAnswers;
    if (totalAnswered === totalExercises) {
        showFinalFeedback();
    }
}

function showFinalFeedback() {
    // Calcular porcentaje
    const percentage = Math.round((correctAnswers / totalExercises) * 100);
    
    // Mostrar números
    document.getElementById('correct-count').textContent = correctAnswers;
    document.getElementById('incorrect-count').textContent = incorrectAnswers;
    document.getElementById('percentage-display').textContent = percentage + '%';
    
    // Mensaje basado en desempeño
    let message = "";
    if (percentage >= 60) {
        message = "¡Lo hiciste muy bien, sigue así!";
    } else {
        message = "¡Uy! Sigue intentando, si quieres mejorar ¡Tu puedes!";
    }
    document.getElementById('final-message').textContent = message;
    
    // Mostrar pantalla final
    document.getElementById('final-feedback').style.display = 'block';
    
    // Desplazar al final de la página
    setTimeout(() => {
        document.getElementById('final-feedback').scrollIntoView({ behavior: 'smooth' });
    }, 500);
} // Fin de checkAnswer 
function showSolution(i){
    let sol = document.getElementById("sol-"+i);
    if (!sol) return;

    // *** CAMBIO CLAVE 1: USAR innerHTML ***
    sol.innerHTML = problems[i].solution;
    sol.style.display="block";

    // *** CAMBIO CLAVE 2: FORZAR RENDERIZADO DE MATHJAX ***
    if (window.MathJax) {
        MathJax.typesetPromise([sol]).then(() => {
            console.log("Ecuaciones renderizadas por showSolution");
        }).catch((err) => console.log("Error MathJax:", err));
    }
}
// Generar primer ejercicio 4 al cargar (para que problems[3] tenga valor)
ejecutarEj4();

    </script>
</body>
</html>
   