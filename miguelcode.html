<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ejercicios: Tuber√≠as en Serie</title>
    <style>
        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            padding: 24px;
            background: #f7f9fc;
            color: #0f172a
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(12,20,45,0.08)
        }

        h1 {
            margin-top: 0
        }

        .exercise {
            display: none;
        }

            .exercise.active {
                display: block;
            }

        .controls {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .feedback {
            margin-top: 8px;
            font-weight: 600
        }

            .feedback.error {
                color: #b91c1c
            }

            .feedback.success {
                color: #0f9d58
            }

        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e1
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 0;
            cursor: pointer
        }

            button.primary {
                background: #2563eb;
                color: white
            }

            button.secondary {
                background: #94a3b8;
                color: white
            }

        .solution {
            margin-top: 10px;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;   /* üëà ESTA L√çNEA */
            }

        .nav {
            display: flex;
            gap: 8px;
            margin-top: 16px
        }

        .retroalimentacion {
            background: #f1f5f9;
            border-left: 4px solid #2563eb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

            .retroalimentacion h3 {
                margin-top: 0;
                color: #1e3a8a
            }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ejercicios: Tuber√≠as en Serie</h1>
        <p>Responde las preguntas en los cuadros de texto. Si tu respuesta es correcta, ver√°s la retroalimentaci√≥n con el proceso completo.</p>

        <div id="exercises">

            <!-- Ejercicio 1 -->
            <section class="exercise active" data-index="0" id="ex-0">
                <h2>Ejercicio 1</h2>
                <p>
                    Para el sistema mostrado en la figura fluye agua a
                    <input type="number" id="temperature" placeholder="Insertar T" min="32" max="212" style="width: 90px; height: 20px ;font-size: 16px;"> ¬∞F
                    por una tuberia de hierro ductil revestida cuyos diametros son
                    <input type="number" id="diametro_1" placeholder="diametro 1" min="3" max="25" style="width: 90px; height: 20px ;font-size: 16px;"> ,
                    <input type="number" id="diametro_2" placeholder="diametro 2" min="3" max="25" style="width: 90px; height: 20px ;font-size: 16px;"> y
                    <input type="number" id="diametro_3" placeholder="diametro 3" min="3" max="25" style="width: 90px; height: 20px ;font-size: 16px;"> pulgadas, con longitud igual a
                    <input type="number" id="longitud_1" placeholder="longitud 1" min="0" style="width: 90px; height: 20px ;font-size: 16px;">,
                    <input type="number" id="longitud_2" placeholder="longitud 2" min="0" style="width: 90px; height: 20px ;font-size: 16px;">
                    y
                    <input type="number" id="longitud_3" placeholder="longitud 3" min="0" style="width: 90px; height: 20px ;font-size: 16px;"> pies, respectivamente.
                    Se sabe que el caudal es de <input type="number" id="caudal_ej1" placeholder="caudal" style="width: 90px; height: 20px ;font-size: 16px;"> gal/min. Determine la diferencia de altura entre los puntos A y B. Las contracciones son s√∫bitas.
                </p>

                <img src="d1.png" alt="Image" height="300" width="600">

                <label for="ans-0">Respuesta (ft):</label>
                <input type="text" id="ans-0" placeholder="Escribe la respuesta num√©rica">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar soluci√≥n</button>
                </div>

                <div class="feedback" id="fb-0" aria-live="polite"></div>
                <div class="solution" id="sol-0" style="display:none"></div>
            </section>

            <!-- Ejercicio 2 -->
            <section class="exercise" data-index="1" id="ex-1">
                <h2>Ejercicio 2</h2>
                <p>Para el sistema mostrado, fluye agua a 70¬∞F por tres tramos de tuber√≠a de hierro d√∫ctil revestida de di√°metros 3", 4" y 6", con longitudes 65, 110 y 185 ft, respectivamente. El caudal es 240.8 gal/min.</p>
                <img src="pag1.jpg" alt="Image" height="200" width="500">

                <label for="ans-1">Respuesta (ft):</label>
                <input type="text" id="ans-1" placeholder="Escribe la respuesta num√©rica">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar soluci√≥n</button>
                </div>

                <div class="feedback" id="fb-1"></div>
                <div class="solution" id="sol-1" style="display:none"></div>
                <div id="retro-1" class="retroalimentacion" style="display:none;"></div>
            </section>

            <!-- Ejercicio 3 -->
            <section class="exercise" data-index="2" id="ex-2">
                <h2>Ejercicio 3</h2>
                <p>Dos tuber√≠as iguales en serie tienen p√©rdidas h_each = 4 m cada una. ¬øCu√°l es la p√©rdida total?</p>

                <label for="ans-2">Respuesta (m):</label>
                <input type="text" id="ans-2" placeholder="Escribe la respuesta num√©rica">

                <div class="controls">
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar soluci√≥n</button>
                </div>

                <div class="feedback" id="fb-2"></div>
                <div class="solution" id="sol-2" style="display:none"></div>
            </section>

            <!-- Ejercicio 4 (nuevo) -->
            <section class="exercise" data-index="3" id="ex-3">
                <h2>Ejercicio 4 ‚Äî Di√°metro requerido (Darcy + Colebrook)</h2>
                <p>
                    Para un sistema de tuber√≠a horizontal se requiere definir su di√°metro si la ca√≠da m√°xima de presi√≥n entre dos puntos separados <b id="L-span">2000</b> ft es de <b id="dP-span">8</b> psi.
                    El flujo volum√©trico requerido en el sistema es de <b id="Q-span">2.5</b> ft¬≥/s. La tuber√≠a debe ser de cobre tipo K. El fluido es agua a 150¬∞F.
                    (Valores fijos usados: Œ≥=61.2 lb/ft¬≥, ŒΩ=4.68e-6 ft¬≤/s, Œµ=5e-6 ft)
                </p>

                <label for="ans-3">Ingrese su resultado (in):</label>
                <input type="text" id="ans-3" placeholder="Di√°metro (in)">

                <div class="controls" style="margin-top:10px;">
                    <!-- Al presionar 'Comprobar' en este ejercicio primero se calcular√° (ejecutarEj4) y luego se validar√° -->
                    <button class="primary" data-action="check">Comprobar</button>
                    <button class="secondary" data-action="show-solution">Mostrar soluci√≥n</button>
                    <button class="secondary" id="nuevo-4">Generar otro ejercicio</button>
                </div>

                <div class="feedback" id="fb-3" aria-live="polite"></div>
                <div class="solution" id="sol-3" style="display:none; white-space: pre-wrap;"></div>
            </section>

        </div>

        <div class="nav">
            <button id="prev">Anterior</button>
            <button id="next">Siguiente</button>
            <div style="flex:1"></div>
            <button id="reset">Reiniciar</button>
        </div>

    </div>

    <script>
/* -------------------------
   TODAS las CONSTANTES
------------------------- */
const temperaturasSI = [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100];
const p_especificoSI = [9.81,9.81,9.81,9.81,9.79,9.78,9.77,9.75,9.73,9.71,9.69,9.67,9.65,9.62,9.59,9.56,9.53,9.50,9.47,9.44,9.40];
const densidadSI = [1000,1000,1000,1000,998,997,996,994,992,990,988,986,984,981,978,975,971,968,965,962,958];
const v_cinematicaSI = [1.75e-6,1.52e-6,1.30e-6,1.15e-6,1.02e-6,8.94e-7,8.03e-7,7.22e-7,6.56e-7,6.00e-7,5.48e-7,5.05e-7,4.67e-7,4.39e-7,4.11e-7,3.83e-7,3.60e-7,3.41e-7,3.22e-7,3.04e-7,2.94e-7];

const temperaturasIN = [32,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,212];
const p_especificoIN = [62.4,62.4,62.4,62.4,62.3,62.2,62.1,62.0,61.9,61.7,61.5,61.4,61.2,61.0,60.8,60.6,60.4,60.1,59.8];
const densidadIN = [1.94,1.94,1.94,1.94,1.94,1.93,1.93,1.93,1.92,1.92,1.91,1.91,1.90,1.90,1.89,1.88,1.88,1.87,1.86];
const v_cinematicaIN = [1.89e-5,1.67e-5,1.40e-5,1.21e-5,1.05e-5,9.15e-6,8.29e-6,7.37e-6,6.55e-6,5.94e-6,5.49e-6,5.03e-6,4.68e-6,4.38e-6,4.07e-6,3.84e-6,3.62e-6,3.35e-6,3.17e-6];

const g = 32.17;
const rug_HDR_IN = 0.0004;

const K_contraccion = {
  "2_pies_s":[0.00,0.03,0.07,0.17,0.26,0.34,0.38,0.40,0.42,0.44,0.47,0.48,0.49],
  "4_pies_s":[0.00,0.04,0.07,0.17,0.26,0.34,0.37,0.40,0.42,0.44,0.46,0.47,0.48],
  "6_pies_s":[0.00,0.04,0.07,0.17,0.26,0.34,0.37,0.39,0.41,0.43,0.45,0.47,0.48],
  "8_pies_s":[0.00,0.04,0.08,0.18,0.26,0.33,0.36,0.39,0.40,0.42,0.44,0.45,0.47],
  "10_pies_s":[0.00,0.05,0.08,0.18,0.26,0.33,0.36,0.38,0.40,0.42,0.45,0.46,0.47],
  "15_pies_s":[0.00,0.05,0.08,0.18,0.25,0.32,0.34,0.37,0.38,0.40,0.45,0.45,0.47],
  "20_pies_s":[0.00,0.05,0.09,0.18,0.25,0.31,0.33,0.35,0.37,0.39,0.46,0.47,0.47],
  "30_pies_s":[0.00,0.06,0.10,0.19,0.25,0.29,0.32,0.33,0.34,0.36,0.46,0.47,0.40],
  "40_pies_s":[0.00,0.06,0.11,0.20,0.24,0.27,0.29,0.30,0.31,0.33,0.38,0.40,0.38]
};

const claves = ["2_pies_s","4_pies_s","6_pies_s","8_pies_s","10_pies_s","15_pies_s","20_pies_s","30_pies_s","40_pies_s"];
const claves_value = [2,4,6,8,10,15,20,30,40];
const D1_D2 = [1.0,1.1,1.2,1.4,1.6,1.8,2.0,2.2,2.5,3.0,4.0,5.0,10.0];
let Za_correct = null;

/* -------------------------
   Funciones auxiliares
------------------------- */
function velocity(caudal, d1, d2, d3){
    let v1 = caudal*0.00222801 / (((d1/12)**2)*Math.PI/4);
    let v2 = caudal*0.00222801 / (((d2/12)**2)*Math.PI/4);
    let v3 = caudal*0.00222801 / (((d3/12)**2)*Math.PI/4);
    return {v1, v2, v3};
}

function subindice_inferior(lista, valor){
    if (valor < lista[0]) return 0;
    for (let i=0;i<lista.length;i++){
        if (lista[i] > valor) return i-1;
        if (lista[i] === valor) return i;
    }
    return lista.length - 1;
}

function subindice_superior(lista, valor){
    if (valor <= lista[0]) return 0;
    for (let i=0;i<lista.length;i++){
        if (lista[i] >= valor) return i;
    }
    return lista.length - 1;
}

function interpolacion(x0,y0,x1,y1,x){
    if (x0 == x1){
        return y0;
    }

    if (x0 != x1){
        let int = y0 + ((y1-y0)/(x1-x0))*(x-x0);
        return int;
    }

}

function factorf(d, Re){
    if (Re < 2000) return 64/Re;
    return 0.25 / (Math.log10(rug_HDR_IN/(3.7*(d/12)) + 5.74/(Re**0.9))**2);
}

function losses(f, L, v, d){
    return f * (L/(d/12)) * (v**2/(2*g));
}

function contractionlosses(k, v){
    return k*(v**2)/(2*g);
}

let solucionfinal1 ="";
/* ---------------------------------------------------------
  FUNCI√ìN EJECUTAR EJERCICIO 1
--------------------------------------------------------- */
function ejecutarEj1(){
    let Q_ej1 = parseFloat(document.getElementById('caudal_ej1').value);
    let d1 = parseFloat(document.getElementById('diametro_1').value);
    let d2 = parseFloat(document.getElementById('diametro_2').value);
    let d3 = parseFloat(document.getElementById('diametro_3').value);
    let T = parseFloat(document.getElementById('temperature').value);
    let L1 = parseFloat(document.getElementById('longitud_1').value);
    let L2 = parseFloat(document.getElementById('longitud_2').value);
    let L3 = parseFloat(document.getElementById('longitud_3').value);

    if (isNaN(Q_ej1)||isNaN(d1)||isNaN(d2)||isNaN(d3)||T<32||d1<d2||d2<d3){
        alert("Datos inv√°lidos.");
        return;
    }

    const velocidades = velocity(Q_ej1, d1, d2, d3);

    let si = subindice_inferior(temperaturasIN, T);
    let ss = subindice_superior(temperaturasIN, T);

    let vis_inf = v_cinematicaIN[si];
    let vis_sup = v_cinematicaIN[ss];
    let T_inf = temperaturasIN[si];
    let T_sup = temperaturasIN[ss];

    let visc;
    if (T_inf===T_sup) visc = vis_inf;
    else visc = vis_inf + ((vis_sup-vis_inf)/(T_sup-T_inf))*(T-T_inf);

    let r1 = d1/d2;
    let r2 = d2/d3;
    // limitar la relacion entre los diametros. Esto es: si r1> 10{ r1 = 10} igualmente con r2
    if (r1 > 10){
        r1 = 10;
    }
    if (r2 > 10){{
        r2 = 10;
    }}
    const v1 = velocidades.v1;
    const v2 = velocidades.v2;
    const v3 = velocidades.v3;
    // K1 //
    let si_v2 = subindice_inferior(claves_value, v2);   // Subindice inferior velocidad 2
    let ss_v2 = subindice_superior(claves_value, v2);      // subindice superior velocidad 2

    let si_rA = subindice_inferior(D1_D2, r1);          // subindice inferior razon de diametros A
    let ss_rA = subindice_superior(D1_D2, r1);          // Subindice superior razon de diametrs A

    let K1_i_i = K_contraccion[claves[si_v2]][si_rA];   // K1  inferior izquierdo
    let K1_s_i = K_contraccion[claves[ss_v2]][ss_rA];   // K1  superior izquierdo

    let K1_i_d = K_contraccion[claves[Math.min(si_v2+1,claves.length-1)]][si_rA];       // K1 inferior derecho
    let K1_s_d = K_contraccion[claves[Math.min(ss_v2+1,claves.length-1)]][ss_rA];       // k2 superior derecho

    let K1_inf = interpolacion(claves_value[si_v2],K1_i_i,claves_value[Math.min(si_v2+1,claves.length-1)],K1_i_d,v2);   // Interpolando
    let K1_sup = interpolacion(claves_value[ss_v2],K1_s_i,claves_value[Math.min(ss_v2+1,claves.length-1)],K1_s_d,v2);   // Interpolando
    let K1 = interpolacion(D1_D2[si_rA],K1_inf,D1_D2[ss_rA],K1_sup,r1);


    /* ---- K2 ---- */
    let si_v3 = subindice_inferior(claves_value, v3);
    let ss_v3 = subindice_superior(claves_value, v3);

    let si_rB = subindice_inferior(D1_D2, r2);
    let ss_rB = subindice_superior(D1_D2, r2);

    let K2_i_i = K_contraccion[claves[si_v3]][si_rB];
    let K2_s_i = K_contraccion[claves[ss_v3]][ss_rB];

    let K2_i_d = K_contraccion[claves[Math.min(si_v3+1,claves.length-1)]][si_rB];
    let K2_s_d = K_contraccion[claves[Math.min(ss_v3+1,claves.length-1)]][ss_rB];

    let K2_inf = interpolacion(claves_value[si_v3],K2_i_i,claves_value[Math.min(si_v3+1,claves.length-1)],K2_i_d,v3);
    let K2_sup = interpolacion(claves_value[ss_v3],K2_s_i,claves_value[Math.min(ss_v3+1,claves.length-1)],K2_s_d,v3);
    let K2 = interpolacion(D1_D2[si_rB],K2_inf,D1_D2[ss_rB],K2_sup,r2);

    let Re1 = v1*(d1/12)/visc;
    let Re2 = v2*(d2/12)/visc;
    let Re3 = v3*(d3/12)/visc;

    let f1 = factorf(d1, Re1);
    let f2 = factorf(d2, Re2);
    let f3 = factorf(d3, Re3);

    let h1 = losses(f1, L1, v1, d1);
    let h2 = losses(f2, L2, v2, d2);
    let h3 = losses(f3, L3, v3, d3);

    let hc1 = contractionlosses(K1, v2);
    let hc2 = contractionlosses(K2, v3);

    let hvB = (v3**2)/(2*g);

    Za_correct = h1 + h2 + h3 + hvB + hc1 + hc2;
    
    solucionfinal1 =`Datos calculados:
    Teniendo el caudal y el diametro de cada tuber√≠a, la velocidad se calcula de la forma
    v = Q/A
    Velocidad secci√≥n 1 = ${v1} ft/s
    Velocidad secci√≥n 2 = ${v2} ft/s 
    Velocidad secci√≥n 3 = ${v3} ft/s

    Viscocidad cinem√°tica en base a la temperatura:${visc} ft^2 /s
    N√∫mero de Reynolds
    Re = (vd)/vc                Donde vc es viscocidad cinem√°tica.

    Re 1 = ${Re1}
    Re 2 = ${Re2}
    Re 3 = ${Re3}

    La rugosidad para este problema es de: ${rug_HDR_IN} ft

    Factor de fricci√≥n calculado con la ecuaci√≥n de Swamee-Jean
    f1 =${f1}
    f2 =${f2}
    f3 =${f3}

    P√©rdidas por en cada secci√≥n empleando la ecuaci√≥n de darcy:

    hl= f (L/d)(v^2 /2g)
    P√©rdida secci√≥n 1 = ${h1} ft
    P√©rdida secci√≥n 2 = ${h2} ft
    P√©rdida secci√≥n 3 = ${h3} ft
    Constantes K interpoladas de las tablas:
    K1 = ${K1}
    K2 = ${K2}
    P√©rdidas por contracciones s√∫bitas:
    hc1 =${hc1} ft
    hc2 =${hc2} ft
    Za - Zb = ${Za_correct} ft
    `;

    problems[0] = { answer: ()=>Za_correct, solution: solucionfinal1 };

    
    
}

/* -------------------------
   EJERCICIO 4: Darcy + Colebrook (aleatorio)
   - genera Q, dP, L en los rangos pedidos
   - itera para obtener D y f
   - selecciona di√°metro comercial (tabla usada previamente)
   - actualiza problems[3] para que checkAnswer lo use
------------------------- */

let diaComercial_in = null; // valor a comparar en pulgadas (se actualizar√°)
let ultimaSolucionText = ''; // texto detallado de la soluci√≥n (para mostrar)

function aleatorio(min, max){
    return Math.random()*(max-min)+min;
}

function ejecutarEj4(){
    // Rangos pedidos
    let Q = parseFloat(aleatorio(1.5,3).toFixed(4)); // ft3/s
    let deltaP = parseFloat(aleatorio(8,15).toFixed(3)); // psi
    let L = parseFloat(aleatorio(1500,3000).toFixed(0)); // ft

    // mostrar en el enunciado los valores actuales
    document.getElementById('Q-span').textContent = Q;
    document.getElementById('dP-span').textContent = deltaP;
    document.getElementById('L-span').textContent = L;

    // Propiedades fijas
    const gamma = 61.2; // lb/ft3
    const nu = 4.68e-6; // ft2/s
    const eps = 5e-6; // ft
    const g_local = 32.17; // ft/s2

    // convertir diferencia de presion a altura (ft)
    const h = (deltaP * 144) / gamma; // ft

    // Iteraci√≥n: usamos esquema similar al que describiste
    // Partimos con f inicial y D inicial (ft)
    let f = 0.02;
    let D = 0.6; // ft
    let D_new = D;
    let iter = 0;

    while(iter < 200){
        // ecuaci√≥n (1): D = [ f * (8 L Q^2) / (pi^2 g h) ]^(1/5)
        D_new = Math.pow( f * (8 * L * Q * Q) / (Math.PI*Math.PI * g_local * h), 1/5 );

        // Reynolds (usando Re = 4Q/(pi D nu))
        let Re = (4 * Q) / (Math.PI * D_new * nu);

        // Actualizar f usando aproximaci√≥n impl√≠cita de Colebrook (punto fijo)
        // 1/sqrt(f) = -2 log10( eps/(3.7D) + 2.51/(Re sqrt(f)) )
        let rhs = -2 * Math.log10( eps/(3.7*D_new) + 2.51/(Re * Math.sqrt(f)) );
        let f_new = 1.0 / (rhs * rhs);

        // relajaci√≥n para estabilidad
        f = 0.6*f + 0.4*f_new;

        // chequeo de convergencia
        if (Math.abs(D_new - D) < 1e-7 && Math.abs(f_new - f) < 1e-8) break;

        D = D_new;
        iter++;
    }

    // resultado final
    let D_ft = D_new;
    let D_in = D_ft * 12;

    // Tabla comercial utilizada (la misma que usamos antes)
    const tabla_comercial_in = [0.5,0.75,1,1.25,1.5,2,2.5,3,4,6,8,10,12];

    // elegir el menor di√°metro comercial >= D_in (por exceso)
    diaComercial_in = tabla_comercial_in.find(d => d >= D_in) || tabla_comercial_in[tabla_comercial_in.length-1];

    // preparar texto de soluci√≥n detallada
    ultimaSolucionText =
`Datos generados:
  Q = ${Q.toFixed(4)} ft¬≥/s
  ŒîP = ${deltaP.toFixed(3)} psi
  L = ${L} ft

Propiedades:
  Œ≥ = ${gamma} lb/ft¬≥
  ŒΩ = ${nu} ft¬≤/s
  Œµ = ${eps} ft

Iteraci√≥n Darcy‚ÄìColebrook (convergencia en ${iter} iteraciones):
  Di√°metro calculado = ${D_ft.toFixed(6)} ft = ${D_in.toFixed(4)} in
  Factor de fricci√≥n f ‚âà ${f.toFixed(6)}
  Reynolds aproximado (√∫ltima iteraci√≥n) ‚âà ${( (4*Q)/(Math.PI   *D_ft*nu) ).toExponential(3)}

Di√°metro comercial seleccionado (por exceso) = ${diaComercial_in} in
`;

    // Actualizar objeto problems[3] para que checkAnswer lo use
    if (problems.length < 4){
        problems[3] = { answer: ()=>diaComercial_in, solution: ultimaSolucionText };
    } else {
        problems[3].answer = ()=>diaComercial_in;
        problems[3].solution = ultimaSolucionText;
    }

    // mostrar soluci√≥n condensada en sol-3 (oculta por defecto; s√≥lo se muestra cuando hay error o Show solution)
    document.getElementById('sol-3').textContent = ultimaSolucionText;
    // no forzar display:block aqu√≠ para no tapar el input
    document.getElementById('sol-3').style.display = "none";

    // devolver el valor calculado para uso inmediato (si se desea)
    return {D_ft, D_in, diaComercial_in, f, ultimaSolucionText};
}

/* -------------------------
   PROBLEMAS Y CHECKEO
   (agregamos placeholder en index 3; se actualizar√° en ejecutarEj4)
------------------------- */
let problems = [
    { answer: ()=>{ return null; }, solution: "Soluci√≥n del Ejercicio 1 (a√∫n no generada)." },
    { answer: ()=>21.92,     solution: "zA - zB = 21.92 ft." },
    { answer: ()=>8,         solution: "h_total = 8 m" },
    { answer: ()=>{ return null; }, solution: "Soluci√≥n del Ejercicio 4 (a√∫n no generada)." }
];

/* -------------------------
   Navegaci√≥n
------------------------- */
let current = 0;
const exerciseEls = document.querySelectorAll('.exercise');

function showExercise(i){
    exerciseEls.forEach((el,idx)=>el.classList.toggle("active", idx===i));
    current = i;
}

document.getElementById("prev").onclick = () => showExercise(Math.max(0,current-1));
document.getElementById("next").onclick = () => showExercise(Math.min(exerciseEls.length-1,current+1));

document.getElementById("reset").onclick = () => {
    for(let i=0;i<exerciseEls.length;i++){
        let ansEl = document.getElementById("ans-"+i);
        if(ansEl) ansEl.value="";
        let fbEl = document.getElementById("fb-"+i);
        if(fbEl) fbEl.textContent="";
        let solEl = document.getElementById("sol-"+i);
        if(solEl) solEl.style.display="none";
        let r = document.getElementById("retro-"+i);
        if(r) r.style.display="none";
    }
    showExercise(0);
};

/* -------------------------
   Eventos de botones (un solo listener)
------------------------- */
document.getElementById("exercises").addEventListener("click", e=>{
    let action = e.target.getAttribute("data-action");
    if (!action) return;

    let section = e.target.closest(".exercise");
    let idx = Number(section.dataset.index);

    // si es el ejercicio 0 y pulsaron Comprobar, ejecuta su c√°lculo especial
    if (idx === 0 && action === "check") {
        ejecutarEj1();  // bot√≥n azul del Ej1
        // permitir que luego checkAnswer(0) sea llamado m√°s abajo
    }

    // si es el ejercicio 3 y pulsaron Comprobar, primero generamos/ejecutamos y actualizamos la respuesta correcta
    if (idx === 3 && action === "check") {
        ejecutarEj4();
        // ahora problems[3] fue actualizado con la soluci√≥n comercial
    }

    // ahora el comportamiento general
    if (action === "check") checkAnswer(idx);
    if (action === "show-solution") showSolution(idx);
});

// bot√≥n separado para generar otro ejercicio 4 (sin comprobar)
document.getElementById("nuevo-4").addEventListener("click", function(){
    ejecutarEj4();
    // limpiar el input y feedback
    let ans = document.getElementById("ans-3");
    if (ans) ans.value = "";
    let fb = document.getElementById("fb-3");
    if (fb) { fb.textContent = ""; fb.className = "feedback"; }
    // mantener la soluci√≥n oculta
    document.getElementById('sol-3').style.display = "none";
});

/* -------------------------
   Eventos comunes y utilidades
------------------------- */

function normalizeNumberInput(v){
    return Number(String(v).trim().replace(",","."));
}

function checkAnswer(i){
    let input = document.getElementById("ans-"+i);
    let fb = document.getElementById("fb-"+i);
    let sol = document.getElementById("sol-"+i);

    // si no existe input (ej. ejercicios sin respuesta escrita) salir
    if (!input || !fb || !sol){
        return;
    }

    let val = normalizeNumberInput(input.value);

    let correct = (typeof problems[i].answer === "function")
                    ? problems[i].answer()
                    : problems[i].answer;

    if (correct === null || typeof correct === "undefined"){
        fb.textContent="A√∫n no hay soluci√≥n generada para este ejercicio.";
        fb.className="feedback error";
        return;
    }

    if (isNaN(val)){
        fb.textContent="N√∫mero inv√°lido.";
        fb.className="feedback error";
        return;
    }

    let errorPermitido = 0.05; // 5%

    if (Math.abs(val - correct) <= Math.abs(correct)*errorPermitido){
        fb.textContent="Correcto ‚úî";
        fb.className="feedback success";
        sol.style.display="none";
    } else {
        fb.textContent="Incorrecto ‚úò";
        fb.className="feedback error";
        sol.textContent = `Soluci√≥n (valor comercial): ${correct.toFixed(3)} in\n\n${problems[i].solution}`;
        sol.style.display="block";
    }
}

function showSolution(i){
    let sol = document.getElementById("sol-"+i);
    if (!sol) return;

    // Ejercicio 1 usa solucionfinal1
    if (i === 0){
        sol.textContent = solucionfinal1;
        sol.style.display="block";
        return;
    }

    // Otros ejercicios (2, 3, 4)
    sol.textContent = problems[i].solution;
    sol.style.display="block";
}

// Generar primer ejercicio 4 al cargar (para que problems[3] tenga valor)
ejecutarEj4();

    </script>
</body>
</html>
